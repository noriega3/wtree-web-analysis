<!-- Welcome!
     ========

     This is a list view for employees that work at WillowTree.


     What it does:
     ~~~~~~~~~~~~~

     - Lists employees photos & names.
     - Search for an employee by name.
     - Sort employees by their first names.
     - Sort empolyees by their last names.
     - Shuffle the list order (because why not).

     Implementation details:
     ~~~~~~~~~~~~~~~~~~~~~~~

     - No compile stepâ€”Just open this file in a browser.
     - The view layer is written in React (without JSX).
       * If you don't know React, don't fret! The logic lives
         outside of it for the most part.


     So... what now?
     ~~~~~~~~~~~~~~~

     Take a look at the code. It works on the surface, but can it be
     improved? Are there things that you would do differently?

     Change it & Have fun!


     Misc. Notes
     ~~~~~~~~~~~

     This code is only expected to work in the latest version of
     Google Chrome. Feel free to use all the latest & greatest
     things that are offered (new API's for JS, CSS, etc.).

     Currently this project does _not_ have a build step (i.e. it runs
     directly by opening the file in Google Chrome). If you finish
     with improvements & feel like there isn't much else to do _then_
     add in a build step if you wish. This is NOT strictly required.

   -->
<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Single Page Application</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }

        .app-container {
            width: 400px;
            margin: 0 auto 0 auto;
        }

        .image {
            width: 100px;
            height: 100px;
        }

        .list-container {
            width: 100%;
            border: 1px solid black;
        }
    </style>
</head>
<body>
<!-- Container for our application -->
<div id="app"></div>


<!-- 3rd Party Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.6.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.6.1/umd/react-dom.production.min.js"></script>

<!-- Our Application Logic -->
<script>
    window.onload = function(){
        var ele = React.createElement;

    /*==================================================

     API

     ***************************************************/

    /**
     * Get the data from the namegame endpoint.
     *
     * The data comes back in the format:
     *
     *    [
     *        { firstName: 'Viju,  lastName: 'Legard',  headshot: { url: '...' } },
     *        { firstName: 'Matt', lastName: 'Seibert', headshot: { url: '...' } },
     *        ...
     *    ]
     */
    function getPersonList() {
        return new Promise((resolve, reject) => {
            fetch('https://willowtreeapps.com/api/v1.0/profiles')
                .then(response => {
                    if (response.status !== 200) {
                        reject(new Error("Error!"));
                    }

                    response.json().then(imageList => {
                        resolve(imageList);
                    });
                });
        });
    }


    /*==================================================

     DATA TRANSFORMS

     ***************************************************/


    function getLastName(person) {
        return person.lastName;
    }

    const getFirstName = (person) => {
        return person.firstName;
    };

    // headshot URLs are scheme relative //
    // prepend http: to prevent invalid schemes like file:// or uri://
        const getImageUrl = ({url='//images.ctfassets.net/3cttzl4i3k1h/1PoufpRNis4mmAmiqkA0ge/ef1fc7606584d54b5892010a65a5a262/WT_Logo-Hye-tTeI0Z.png'}) => {
            return `http:${url}`;
    };

    /**
     * Fisher-Yates shuffle
     */
    function shuffleList(list) {
        // Make a copy & don't mutate the passed in list
        let result = list.slice(1);

        let tmp, j, i = list.length - 1

        for (; i > 0; i -= 1) {
            j = Math.floor(Math.random() * (i + 1));
            tmp = list[i];
            list[i] = list[j];
            list[j] = tmp;
        }

        return result;
    }


    /**
     * Remove any people that do not have the name we are
     * searching for.
     */
    function filterByName(searchForName, personList) {
            var searchTerm = searchForName.toString().toLowerCase();
            return personList.filter(({firstName, lastName}) => {
                return firstName.toLowerCase().startsWith(searchTerm) || lastName.toLowerCase().startsWith(searchTerm);
        });
    }


    /**
     * Takes in a property of an object list, e.g. "name" below
     *
     *    people = [{ name: 'Sam' }, { name: 'Jon' }, { name: 'Kevin' }]
     *
     * And returns a function that will sort that list, e.g.
     *
     *    const sortPeopleByName = sortObjListByProp('name');
     *    const sortedPeople = sortPeopleByName(people);
     *
     *  We now have:
     *
     *    console.log(sortedPeople)
     *    > [{ name: 'Jon' }, { name: 'Kevin' }, { name: 'Sam' }]
     *
     */
    function sortObjListByProp(prop) {
        return function(objList) {
            // Make a copy & don't mutate the passed in list
            let result = objList.slice(1);

            result.sort((a, b) => {
                    var [propA] = a[prop].split(" ").slice(-1);
                    var [propB] = b[prop].split(" ").slice(-1);

                    if (propA < propB) {
                    return -1;
                }

                    if (propA > propB) {
                    return 1;
                }

                    return 0;
            });

            return result;
        };
    }

    const sortByFirstName = sortObjListByProp('firstName');

        const sortByLastName = sortObjListByProp('lastName');


    /*==================================================

     VIEW (React)

     ***************************************************/

        const Search = ({onChange}) =>
            ele('input', {
                type: 'input',
                onChange
            });

        const Thumbnail = ({src}) =>
            ele('img',{
                className: 'image',
                src
            });

        const ListRow = ({person: {firstName, lastName, headshot}, ...props}) =>
            ele('tr', { key: `${firstName} ${lastName}` }, [
                ele('td',{ key: 'thumb' }, ele(Thumbnail, { src: getImageUrl(headshot) })),
                ele('td',{ key: 'first' }, null, firstName),
                ele('td',{ key: 'last' }, null, lastName)
            ]);

        const ListContainer = ({personList}) =>
            ele('table', { className: 'list-container' }, [
                ele('thead',{ key: 'thead' }, ele('tr',{}, [
                    ele('th',{ key: 'thumb-h' }, null, 'Thumbnail'),
                    ele('th',{ key: 'first-h' }, null, 'First Name'),
                    ele('th',{ key: 'last-h' }, null, 'Last Name')
                ])),
                ele('tbody',{ key: 'tbody' },
                    personList.map((person, i) => ele(ListRow, { key: `person-${i}`, person }))
                )
        ]);

        const debounce = (fn, time) => {
            let timeout;

            return function (...args) {
                const functionCall = () => fn.apply(this, args);

                clearTimeout(timeout);
                timeout = setTimeout(functionCall, time);
            }
        };

        class App extends React.Component{
            constructor(props){
                super(props);
                this.state = {
                    personList: [],
                    visiblePersonList: []
                };



                this._onSearch = this._onSearch.bind(this);
                this.setVisiblePersonList = debounce(this.setVisiblePersonList, 300);
            }


            componentDidMount() {
                getPersonList().then((personList) =>
                    this.setState({
                        personList,
                        visiblePersonList: personList
                    }));
            }

            _shuffleList() {
                this.setState({
                    visiblePersonList: shuffleList(this.state.personList)
                });
            }

            _sortByFirst() {
                this.setState({
                    visiblePersonList: sortByFirstName(this.state.personList)
                });
            }

            _sortByLast() {
                this.setState({
                    visiblePersonList: sortByLastName(this.state.personList)
                });
            }

            _onSearch(e) {
                e.persist();
                this.setVisiblePersonList(e.target.value)
            }

            setVisiblePersonList(query){
                this.setState({
                    visiblePersonList: filterByName(query, this.state.personList)
                })
            }


            render() {
                const { visiblePersonList } = this.state;

                return ele(ErrorBoundary, null, [
                    ele('div', { className: 'app-container', key: 'app' }, null, [
                        ele(Search, { key: 'search', onChange: this._onSearch}),
                        ele('button', { key: 'shuffle', onClick: this._shuffleList.bind(this) }, null, 'Shuffle'),
                        ele('button', { key: 'sort-first', onClick: this._sortByFirst.bind(this) }, null, 'Sort (First Name)'),
                        ele('button', { key: 'sort-last', onClick: this._sortByLast.bind(this) }, null, 'Sort (Last Name)'),
                        ele(ListContainer, { key: 'list', personList: visiblePersonList })
                    ])
                ]);
            }
        }

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, info) {
                console.error(info);
            }

            render() {
                if (this.state.hasError) {
                    return ele('h1', null, 'Something went wrong.')
                }

                return this.props.children;
            }
        }


        ReactDOM.render(
            ele(App),
            document.getElementById('app')
        );

    }

</script>
</body>
</html>
